<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Identity.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BSNet-DiveLog</a> &gt; <a href="index.html" class="el_package">net.bryansaunders.jee6divelog.security</a> &gt; <span class="el_source">Identity.java</span></div><h1>Identity.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package net.bryansaunders.jee6divelog.security;

/*
 * #%L
 * BSNet-DiveLog
 * $Id:$
 * $HeadURL:$
 * %%
 * Copyright (C) 2012 Bryan Saunders
 * %%
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 3 of the 
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public 
 * License along with this program.  If not, see
 * &lt;http://www.gnu.org/licenses/gpl-3.0.html&gt;.
 * #L%
 */

import java.io.Serializable;
import java.util.Calendar;
import java.util.Date;
import java.util.LinkedHashSet;
import java.util.Set;

import javax.enterprise.context.SessionScoped;
import javax.inject.Inject;
import javax.inject.Named;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlTransient;

import net.bryansaunders.jee6divelog.model.UserAccount;
import net.bryansaunders.jee6divelog.security.enumerator.Permission;
import net.bryansaunders.jee6divelog.security.enumerator.Role;
import net.bryansaunders.jee6divelog.service.UserAccountService;
import net.bryansaunders.jee6divelog.util.SecurityUtils;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * User Identity implements Serializable.
 * 
 * @author Bryan Saunders &lt;btsaunde@gmail.com&gt;
 * 
 */
@SessionScoped
@Named(&quot;identity&quot;)
@XmlRootElement
public class Identity implements Serializable {

    /**
     * Login Failure.
     */
    public static final boolean LOGIN_FAILURE = false;

    /**
     * Login Success.
     */
    public static final boolean LOGIN_SUCCESS = true;

    /**
     * Logout Failure.
     */
    public static final String LOGOUT_FAILURE = &quot;/logout_error&quot;;

    /**
     * Logout Success.
     */
    public static final String LOGOUT_SUCCESS = &quot;/logout_success&quot;;

    /**
     * Identity Logged Out.
     */
<span class="fc" id="L85">    public static final Integer LOGGED_OUT = 1;</span>

    /**
     * Identity Logged In.
     */
<span class="fc" id="L90">    public static final Integer LOGGED_IN = 0;</span>

    /**
     * Default Serial ID.
     */
    private static final long serialVersionUID = 1L;

    /**
     * Logger.
     */
<span class="fc" id="L100">    private final Logger logger = LoggerFactory.getLogger(Identity.class);</span>

    /**
     * User Entered Credentials.
     */
    @Inject
    @XmlTransient
    private Credentials credentials;

    /**
     * User Account Service.
     */
    @Inject
    @XmlTransient
    private UserAccountService userAccountService;

    /**
     * Should the user be Remembered.
     */
    private boolean rememberMe;

    /**
     * Identity Roles.
     */
    private Set&lt;Role&gt; roles;

    /**
     * Identity Permissions.
     */
    private Set&lt;Permission&gt; permissions;

    /**
     * User Public API Key.
     */
    private String publicApiKey;
    
    /**
     * User Private API Key.
     */
    private String privateApiKey;

    /**
     * User API Key Expiration Date.
     */
    private Date apiKeyExpiration;

    /**
     * Identity Status.
     */
    private Integer status;

    /**
     * Default Constructor.
     */
<span class="fc" id="L154">    public Identity() {</span>
<span class="fc" id="L155">        this.roles = new LinkedHashSet&lt;Role&gt;();</span>
<span class="fc" id="L156">        this.permissions = new LinkedHashSet&lt;Permission&gt;();</span>
<span class="fc" id="L157">        this.status = Identity.LOGGED_OUT;</span>
<span class="fc" id="L158">    }</span>

    /**
     * Login Identity.
     * 
     * @return Login Result
     */
    public boolean login() {
<span class="fc" id="L166">        return this.login(false);</span>
    }

    /**
     * Login Identity for REST Service.
     * 
     * @return Login Result
     */
    public boolean restLogin() {
<span class="fc" id="L175">        return this.login(true);</span>
    }

    /**
     * Login Identity.
     * 
     * @param restLogin
     *            Is it a REST Login
     * @return Login Result
     */
    public boolean login(final boolean restLogin) {
<span class="fc" id="L186">        this.logger.debug(&quot;Logging In User with Credentials: &quot; + this.credentials);</span>
<span class="fc" id="L187">        boolean returnValue = Identity.LOGIN_FAILURE;</span>

<span class="fc" id="L189">        final String username = this.getUsername();</span>
<span class="fc" id="L190">        final String password = this.getPassword();</span>
<span class="fc" id="L191">        final String expectedPassword = SecurityUtils.generatePasswordHash(password);</span>

<span class="fc" id="L193">        final UserAccount userAccount = this.userAccountService.findByUserEmail(username);</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">        if (userAccount != null) {</span>
<span class="fc" id="L195">            final String hashedPassword = userAccount.getPassword();</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">            if (hashedPassword.equals(expectedPassword)) {</span>
<span class="fc" id="L197">                this.setStatus(Identity.LOGGED_IN);</span>

<span class="fc" id="L199">                this.setRoles(userAccount.getRoles());</span>
<span class="fc" id="L200">                this.setPermissions(userAccount.getPermissions());</span>

<span class="fc bfc" id="L202" title="All 2 branches covered.">                if (restLogin) {</span>
<span class="fc" id="L203">                    this.publicApiKey = SecurityUtils.generateRestApiKey();</span>
<span class="fc" id="L204">                    this.privateApiKey = SecurityUtils.generateRestApiKey();</span>

<span class="fc" id="L206">                    final Calendar expiration = Calendar.getInstance();</span>
<span class="fc" id="L207">                    expiration.add(Calendar.HOUR, 5);</span>
<span class="fc" id="L208">                    this.apiKeyExpiration = expiration.getTime();</span>

<span class="fc" id="L210">                    userAccount.setPublicApiKey(this.publicApiKey);</span>
<span class="fc" id="L211">                    userAccount.setPrivateApiKey(this.privateApiKey);</span>
<span class="fc" id="L212">                    userAccount.setApiKeyExpiration(this.apiKeyExpiration);</span>
<span class="fc" id="L213">                    this.userAccountService.saveUser(userAccount);</span>
                }

<span class="fc" id="L216">                this.logger.debug(&quot;Logged in User: &quot; + this.credentials);</span>
            }
        }

<span class="fc bfc" id="L220" title="All 2 branches covered.">        if (this.isLoggedIn()) {</span>
<span class="fc" id="L221">            returnValue = Identity.LOGIN_SUCCESS;</span>
        } else {
<span class="fc" id="L223">            this.logger.warn(&quot;Invalid Credentials: &quot; + this.credentials);</span>
        }

<span class="fc" id="L226">        return returnValue;</span>
    }

    /**
     * Logout the current User.
     * 
     * @return Logout Result
     */
    public String logout() {
<span class="fc" id="L235">        this.logger.info(&quot;Logging Out User with Credentials: &quot; + this.credentials);</span>
<span class="fc" id="L236">        String returnValue = Identity.LOGOUT_FAILURE;</span>

<span class="fc" id="L238">        this.setStatus(Identity.LOGGED_OUT);</span>

<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (!this.isLoggedIn()) {</span>
<span class="fc" id="L241">            returnValue = Identity.LOGOUT_SUCCESS;</span>
        }

<span class="fc" id="L244">        return returnValue;</span>
    }

    /**
     * Is the Identity Logged in?
     * 
     * @return true if logged in
     */
    public boolean isLoggedIn() {
<span class="fc" id="L253">        return this.status.equals(Identity.LOGGED_IN);</span>
    }

    /**
     * Get the status.
     * 
     * @return the status
     */
    public Integer getStatus() {
<span class="nc" id="L262">        return this.status;</span>
    }

    /**
     * Set the status.
     * 
     * @param newStatus
     *            the status to set
     */
    public void setStatus(final Integer newStatus) {
<span class="fc" id="L272">        this.status = newStatus;</span>
<span class="fc" id="L273">    }</span>

    /**
     * Get Username.
     * 
     * @return username
     */
    public String getUsername() {
<span class="fc" id="L281">        return this.credentials.getUsername();</span>
    }

    /**
     * Get Password.
     * 
     * @return password
     */
    public String getPassword() {
<span class="fc" id="L290">        return this.credentials.getPassword();</span>
    }

    /**
     * Set the credentials.
     * 
     * @param newCredentials
     *            the credentials to set
     */
    public void setCredentials(final Credentials newCredentials) {
<span class="fc" id="L300">        this.credentials = newCredentials;</span>
<span class="fc" id="L301">    }</span>

    /**
     * Set the userAccountService.
     * 
     * @param newUserAccountService
     *            the userAccountService to set
     */
    public void setUserAccountService(final UserAccountService newUserAccountService) {
<span class="fc" id="L310">        this.userAccountService = newUserAccountService;</span>
<span class="fc" id="L311">    }</span>

    /**
     * Get the roles.
     * 
     * @return the roles
     */
    public Set&lt;Role&gt; getRoles() {
<span class="fc" id="L319">        return this.roles;</span>
    }

    /**
     * Set the roles.
     * 
     * @param newRoles
     *            the roles to set
     */
    public void setRoles(final Set&lt;Role&gt; newRoles) {
<span class="fc" id="L329">        this.roles = newRoles;</span>
<span class="fc" id="L330">    }</span>

    /**
     * Get the permissions.
     * 
     * @return the permissions
     */
    public Set&lt;Permission&gt; getPermissions() {
<span class="fc" id="L338">        return this.permissions;</span>
    }

    /**
     * Set the permissions.
     * 
     * @param newPermissions
     *            the permissions to set
     */
    public void setPermissions(final Set&lt;Permission&gt; newPermissions) {
<span class="fc" id="L348">        this.permissions = newPermissions;</span>
<span class="fc" id="L349">    }</span>

    /**
     * Get the rememberMe.
     * 
     * @return the rememberMe
     */
    public boolean isRememberMe() {
<span class="fc" id="L357">        return this.rememberMe;</span>
    }

    /**
     * Set the rememberMe.
     * 
     * @param newRememberMe
     *            the rememberMe to set
     */
    public void setRememberMe(final boolean newRememberMe) {
<span class="fc" id="L367">        this.rememberMe = newRememberMe;</span>
<span class="fc" id="L368">    }</span>

    /**
     * Has the specified Role.
     * 
     * @param role
     *            Role to check for
     * @return true if role is found
     */
    public boolean hasRole(final Role role) {
<span class="fc" id="L378">        return this.roles.contains(role);</span>
    }

    /**
     * Has the specified Permission.
     * 
     * @param permission
     *            Permission to check for
     * @return true if permission is found
     */
    public boolean hasPermission(final Permission permission) {
<span class="fc" id="L389">        return this.permissions.contains(permission);</span>
    }

    /**
     * Get the Public apiKey.
     * 
     * @return the apiKey
     */
    public String getPublicApiKey() {
<span class="fc" id="L398">        return this.publicApiKey;</span>
    }

    /**
     * Set the Public apiKey.
     * 
     * @param newApiKey
     *            the apiKey to set
     */
    public void setPublicApiKey(final String newApiKey) {
<span class="fc" id="L408">        this.publicApiKey = newApiKey;</span>
<span class="fc" id="L409">    }</span>
    
    /**
     * Get the Private apiKey.
     * 
     * @return the apiKey
     */
    public String getPrivateApiKey() {
<span class="fc" id="L417">        return this.privateApiKey;</span>
    }

    /**
     * Set the Private apiKey.
     * 
     * @param newApiKey
     *            the apiKey to set
     */
    public void setPrivateApiKey(final String newApiKey) {
<span class="fc" id="L427">        this.privateApiKey = newApiKey;</span>
<span class="fc" id="L428">    }</span>

    /**
     * Get the apiKeyExpiration.
     * 
     * @return the apiKeyExpiration
     */
    public Date getApiKeyExpiration() {
<span class="fc" id="L436">        Date date = null;</span>
<span class="fc bfc" id="L437" title="All 2 branches covered.">        if (this.apiKeyExpiration != null) {</span>
<span class="fc" id="L438">            date = new Date(this.apiKeyExpiration.getTime());</span>
        }
<span class="fc" id="L440">        return date;</span>
    }

    /**
     * Set the apiKeyExpiration.
     * 
     * @param newApiKeyExpiration
     *            the apiKeyExpiration to set
     */
    public void setApiKeyExpiration(final Date newApiKeyExpiration) {
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">        if (newApiKeyExpiration == null) {</span>
<span class="nc" id="L451">            this.apiKeyExpiration = null;</span>
        } else {
<span class="fc" id="L453">            this.apiKeyExpiration = new Date(newApiKeyExpiration.getTime());</span>
        }
<span class="fc" id="L455">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.8.201207111220</span></div></body></html>